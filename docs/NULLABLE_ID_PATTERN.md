# Handling Nullable IDs Pattern

## Why IDs are Nullable

In our app, `id`, `createdAt`, and `updatedAt` fields are **optional (nullable)** because:
1. **When creating** new entities, we don't provide IDs - Supabase auto-generates them
2. **After saving** to the database, Supabase returns the entity WITH the generated ID
3. **When reading** from the database, entities ALWAYS have IDs

## The Pattern

### ✅ **When Creating New Entities**

IDs should be `null` - let Supabase generate them:

```dart
// ✅ CORRECT - No ID provided
final newTask = Task(
  title: 'My Task',
  status: TaskStatus.todo,
  priority: TaskPriority.medium,
  // id, createdAt, updatedAt will be null
);

await repository.createTask(newTask); // Supabase generates ID
```

```dart
// ❌ WRONG - Don't generate IDs manually
final newTask = Task(
  id: DateTime.now().millisecondsSinceEpoch.toString(), // ❌ Don't do this
  title: 'My Task',
  // ...
);
```

### ✅ **When Using Entities from Database**

Entities from the database ALWAYS have IDs. Use null checks with the null-assertion operator:

```dart
// Pattern 1: Null check with early return (safest)
Future<void> deleteProject(Project project) async {
  if (project.id == null) {
    // This should never happen, but handle gracefully
    ScaffoldMessenger.of(context).showSnackBar(
      const SnackBar(content: Text('Error: Project ID is missing')),
    );
    return;
  }

  await repository.deleteProject(project.id!);
}
```

```dart
// Pattern 2: Inline null check for callbacks
onDelete: task.id != null
    ? () => controller.deleteTask(task.id!)
    : () {}, // Fallback (should never happen)
```

```dart
// Pattern 3: Null check in method
Future<void> loadTasks() async {
  if (widget.project.id == null) return; // Early exit if no ID

  final tasks = await repository.getTasksByProject(widget.project.id!);
  // ...
}
```

### ✅ **When Updating Entities**

```dart
// Don't manually set updatedAt - Supabase trigger handles it
final updated = task.copyWith(
  title: newTitle,
  status: newStatus,
  // Note: updatedAt is auto-generated by Supabase trigger
);

await repository.updateTask(updated);
```

## Common Scenarios

### Scenario 1: List Screen → Detail Screen

```dart
// In list screen
void _openProject(Project project) {
  // project.id is guaranteed to exist (came from DB)
  context.goToProjectDetail(project);
}
```

### Scenario 2: Passing ID to Repository

```dart
// Method that accepts entity from DB
Future<void> _archiveProject(Project project) async {
  // Add null check for safety
  if (project.id == null) {
    showError('Project ID is missing');
    return;
  }

  // Use null-assertion operator
  await _repository.archiveProject(project.id!);
}
```

### Scenario 3: Detail Screen Loading Data

```dart
@override
void onReady() {
  if (widget.budget.id == null) {
    // Handle edge case
    showError('Cannot load budget without ID');
    return;
  }

  _loadBudgetData(widget.budget.id!);
}
```

## Why This Approach?

### Benefits:
1. ✅ **Prevents manual ID generation** - avoids potential conflicts
2. ✅ **Leverages Supabase features** - auto-generated UUIDs, timestamps, triggers
3. ✅ **Type-safe** - nullable types catch potential bugs at compile time
4. ✅ **Defensive programming** - graceful handling of edge cases

### When to Use Null-Assertion (`!`):
- ✅ After a null check (safe)
- ✅ When entity definitely came from database (safe)
- ❌ Never use without checking if you're unsure

## Quick Reference

| Scenario | ID State | What to Do |
|----------|----------|------------|
| Creating new entity | `null` | Don't provide ID, let Supabase generate |
| Entity from database | **Always has ID** | Add null check, then use `id!` |
| Updating entity | Has ID | Don't update `updatedAt`, let trigger handle it |
| Passing to repository method | **Must have ID** | Check `if (id == null)` first |

## Examples in Our Codebase

### Creating
- ✅ `task_detail_screen.dart:97-104` - Task creation
- ✅ `project_list_screen.dart:54-59` - Project creation
- ✅ `create_budget_screen.dart:67-73` - Budget creation

### Using IDs from DB
- ✅ `project_list_screen.dart:143-162` - Archive project with null check
- ✅ `budget_detail_screen.dart:33-49` - Refresh with null check
- ✅ `project_detail_screen.dart:33-53` - Load tasks with null check

### Callbacks with IDs
- ✅ `task_list_screen_refactored.dart:106-108` - Delete with inline check
